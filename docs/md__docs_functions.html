<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MakerLabs ACM: functions/</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="https://unpkg.com/mermaid@8.0.0/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({
    startOnLoad: true,
    flowchart:{
      useMaxWidth: true,
      htmlLabels: true,
    },
  });
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MakerLabs ACM
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__docs_functions.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">functions/ </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md36"></a>
Overview</h1>
<p>There are two Serverless function handlers used by the ACM:</p><ul>
<li><a class="el" href="group__functions.html#ga3a34d1983ca24bf3375f128701142f4a">/permissions_check</a>, used by the Readers, which receives an <code>ACM</code>.<code><a class="el" href="struct_activity.html" title="Flatbuffer which represents tag scan activity on a specific machine.">Activity</a></code> binary flatbuffer, determines which <code>MakerLabs ID</code> it belongs to, and returns details for the matching user (including current permissions list) as an <code>ACM</code>.<code><a class="el" href="struct_user.html" title="Flatbuffer which represents metadata from a user.">User</a></code> flatbuffer. <dl class="section note"><dt>Note</dt><dd>Located in AWS Lambda, as this made a significant latency improvement resulting in faster scan times. The performance benefit was large enough that this handler was moved to AWS <code>us-west-2</code>. As a result, Firebase credentials must be provided to the handler including which Google Cloud project to use, and a private key for a locked-down Firebase service account which can only access the Firebase Database for that project.</dd></dl>
</li>
<li><a class="el" href="group__functions.html#gacdc4b56953435dee1ff6ffa58a4c00e7">/google_apps_script_proxy</a>, used by the website, which forwards any requests to Google Apps Script and proxies the response so Google Spreadsheets data can be loaded by the website (outside of Google Apps Script hosting limits). <dl class="section note"><dt>Note</dt><dd>This is a Firebase <a class="el" href="struct_function.html">Function</a> deployed to the same project as the website (Firebase Hosting). It is also mapped via URL rewrite to <code>/google_apps_script_proxy</code> on the same domain as the website, so it may be accessed without configuring cross-domain CORS access.</dd></dl>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md37"></a>
Design</h1>
<p>The functions are written in <a href="https://www.dartlang.org/">Dart 2.x</a>, which is converted to Javascript code and uploaded to a "serverless" environment. In this case, two such environments are used:</p><ul>
<li><a href="https://aws.amazon.com/lambda/">AWS Lambda</a> is used for performance critical request/response to Reader unit tag scans (<a class="el" href="group__functions.html#ga3a34d1983ca24bf3375f128701142f4a">/permissions_check</a>).</li>
<li><a href="https://firebase.google.com/docs/functions/">Cloud Functions For Firebase</a> is used for simple request proxying from Firebase Hosting website to access Google Apps Script data such as the form <code>fields</code> JSON (<a class="el" href="group__functions.html#gacdc4b56953435dee1ff6ffa58a4c00e7">/google_apps_script_proxy</a>).</li>
</ul>
<h2>Form Fields/Columns Caching</h2>
<dl class="section note"><dt>Note</dt><dd>The fields JSON used by the <a class="el" href="group__functions.html#ga3a34d1983ca24bf3375f128701142f4a">/permissions_check</a> function is cached between invocations to improve performance (the fields are rarely changing). Generally, AWS Lambda execution units get restarted every few hours (or immediately after a re-deploy), so it may take some amount of time for the <a class="el" href="group__functions.html#ga3a34d1983ca24bf3375f128701142f4a">/permissions_check</a> endpoint to sync with any column changes.</dd></dl>
<h2>Uptime / Ping Check</h2>
<dl class="section note"><dt>Note</dt><dd>To avoid "cold start" latency issues with serverless functions, a healthcheck via Google Cloud Platform Stackdriver was created to ping the endpoint every few minutes (via HTTPS GET, including the <code>?ping=1</code> query arg).</dd></dl>
<h2><a class="el" href="struct_function.html">Function</a> Execution Logs</h2>
<h3>/permissions_check (AWS Lambda)</h3>
<p>These logs are available under AWS CloudWatch for the Lambda handler in the appropriate environment (<code>dev</code> or <code>production</code>).</p>
<dl class="section note"><dt>Note</dt><dd>In AWS, a new log bucket is created every few hours &ndash; each time the Lambda execution unit is restarted.</dd></dl>
<h3>/google_apps_script_proxy (Firebase Functions)</h3>
<p>These logs can be found from the Firebase Console under the Functions section. Logs from multiple execution units are combined together. The same data can also be viewed in Google Cloud Functions dashboard, including metadata regarding when the execution units are restarted.</p>
<dl class="section note"><dt>Note</dt><dd>Advanced function settings such as runtime version (e.g Node 8.x) and memory limits must be configured in Google Cloud Functions console, with the target Firebase Project selected as the Google Platform project.</dd></dl>
<h1><a class="anchor" id="autotoc_md38"></a>
Configuration</h1>
<h2>Dependencies</h2>
<p>The Dart dependencies used at runtime are configured in the <code>pubspec.yaml</code> file. The JS dependencies used by the build/deploy tooling are configured in the <code><a class="el" href="webcomponents_2package_8json.html" title="Runnable targets: serve, build, deploy. LitElement/Polymer npm dependencies.">webcomponents/package.json</a></code> file.</p>
<h2>Google Spreadsheet, Google Cloud Project / Firebase details</h2>
<p>Common customizations such as changing the Spreadsheet ID, Google Cloud/Firebase project name, and Firebase Database credentials for use outside Google (e.g. in AWS Lambda) are configured separately for <code>production</code> and <code>dev</code>/<code>test</code> environments in the <code><a class="el" href="config_8production_8yml.html" title="Environment variables / settings for /permissions_check production environment.">config.production.yml</a></code> and <code>config.dev.yml</code> files, respectively (and deploying with either the <code>--stage production</code> or <code>--stage dev</code> (the default) deploy flag).</p>
<h1><a class="anchor" id="autotoc_md39"></a>
Deployment</h1>
<h2>Build</h2>
<p>Dart code must first be converted to Javascript code through the <code>Dart2JS</code> tool. The build process can be invoked via: </p><div class="fragment"><div class="line">yarn build</div></div><!-- fragment --><p>The results are packaged into the <code>functions/build</code> directory.</p>
<h2>Deploy</h2>
<p>The deployment process can be invoked (it will trigger a rebuild first) via: </p><div class="fragment"><div class="line"># Deploy to the test environment</div><div class="line">yarn deploy</div><div class="line"></div><div class="line"># Deploy to the production environment</div><div class="line"># yarn build</div><div class="line"># firebase deploy --only functions -P production</div><div class="line"># sls deploy --stage production</div></div><!-- fragment --><h1><a class="anchor" id="autotoc_md40"></a>
Observability</h1>
<h2>Viewing the AWS /permissions_check Logs</h2>
<p>The logs for the <a class="el" href="group__functions.html#ga3a34d1983ca24bf3375f128701142f4a">/permissions_check</a> AWS Lambda HTTPS handler can be accessed by the following steps:</p><ul>
<li>Login to the AWS Management Console: <blockquote class="doxtable">
<p><a href="https://us-west-2.console.aws.amazon.com/">https://us-west-2.console.aws.amazon.com/</a> </p>
</blockquote>
</li>
<li>Search for and select the "Cloudwatch" service (or use the following link:) <blockquote class="doxtable">
<p><a href="https://us-west-2.console.aws.amazon.com/cloudwatch">https://us-west-2.console.aws.amazon.com/cloudwatch</a> </p>
</blockquote>
</li>
<li>Select "Logs" from the sidebar</li>
<li>Choose the appropriate "Log Group" (e.g. <code>/aws/lambda/makerlabs-acm-functions-production-permissions_check</code>)</li>
<li>Select the appropriate "Log Stream" for the UTC timerange of interest. (A new <a class="el" href="struct_log.html">Log</a> Stream is created each time the AWS Lambda service is reloaded automatically.)</li>
</ul>
<h1><a class="anchor" id="autotoc_md41"></a>
API Reference</h1>
<p><a class="el" href="group__functions.html">functions/ API Documentation</a> </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.15-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
  </ul>
</div>
</body>
</html>
