define(["exports","../../../@polymer/polymer/polymer-element.js","../../../@polymer/polymer/lib/utils/templatize.js","../../../@polymer/iron-a11y-announcer/iron-a11y-announcer.js","../../../@polymer/iron-a11y-keys-behavior/iron-a11y-keys-behavior.js","../../../@polymer/polymer/lib/utils/flush.js","../../../@polymer/polymer/lib/utils/async.js"],function(_exports,_polymerElement,_templatize,_ironA11yAnnouncer,_ironA11yKeysBehavior,_flush,_async){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.ComboBoxMixin=void 0;_exports.ComboBoxMixin=subclass=>class extends subclass{static get properties(){return{opened:{type:Boolean,notify:!0,value:!1,reflectToAttribute:!0,observer:"_openedChanged"},disabled:{type:Boolean,value:!1,reflectToAttribute:!0},readonly:{type:Boolean,value:!1,reflectToAttribute:!0},items:{type:Array},allowCustomValue:{type:Boolean,value:!1},filteredItems:{type:Array},value:{type:String,observer:"_valueChanged",notify:!0,value:""},_lastCommittedValue:String,loading:{type:Boolean,value:!1,reflectToAttribute:!0},_focusedIndex:{type:Number,value:-1},filter:{type:String,value:"",notify:!0},selectedItem:{type:Object,notify:!0},itemLabelPath:{type:String,value:"label"},itemValuePath:{type:String,value:"value"},name:{type:String},invalid:{type:Boolean,reflectToAttribute:!0,notify:!0,value:!1},_toggleElement:Object,_clearElement:Object,_inputElementValue:String,_closeOnBlurIsPrevented:Boolean,_previousDocumentPointerEvents:String}}static get observers(){return["_filterChanged(filter, itemValuePath, itemLabelPath)","_itemsChanged(items.*, itemValuePath, itemLabelPath)","_filteredItemsChanged(filteredItems.*, itemValuePath, itemLabelPath)","_loadingChanged(loading)","_selectedItemChanged(selectedItem)","_toggleElementChanged(_toggleElement)"]}ready(){super.ready();this.addEventListener("focusout",()=>{if(!this._closeOnBlurIsPrevented){this.close()}});this._lastCommittedValue=this.value;_ironA11yAnnouncer.IronA11yAnnouncer.requestAvailability();this.$.overlay.addEventListener("selection-changed",this._overlaySelectedItemChanged.bind(this));this.addEventListener("vaadin-combo-box-dropdown-closed",this._onClosed.bind(this));this.addEventListener("vaadin-combo-box-dropdown-opened",this._onOpened.bind(this));this.addEventListener("keydown",this._onKeyDown.bind(this));this.addEventListener("click",this._onClick.bind(this));this.$.overlay.addEventListener("vaadin-overlay-touch-action",this._onOverlayTouchAction.bind(this));this.addEventListener("touchend",e=>{if(!this._clearElement||e.composedPath()[0]!==this._clearElement){return}e.preventDefault();this._clear()})}open(){if(!this.disabled&&!this.readonly){this.opened=!0}}close(){this.opened=!1}_openedChanged(value,old){if(old===void 0){return}if(this.opened){this._openedWithFocusRing=this.hasAttribute("focus-ring")||this.focusElement&&this.focusElement.hasAttribute("focus-ring");if(!this.$.overlay.touchDevice){if(!this.focused){this.focus()}}}else if(this._openedWithFocusRing&&this.hasAttribute("focused")){this.focusElement.setAttribute("focus-ring","")}}_onOverlayTouchAction(){this._closeOnBlurIsPrevented=!0;this.inputElement.blur();this._closeOnBlurIsPrevented=!1}_onClick(e){this._closeOnBlurIsPrevented=!0;const path=e.composedPath();if(-1!==path.indexOf(this._clearElement)){this._clear();this.focus()}else if(-1!==path.indexOf(this.inputElement)){if(-1<path.indexOf(this._toggleElement)&&this.opened){this.close()}else{this.open()}}this._closeOnBlurIsPrevented=!1}_onKeyDown(e){if(this._isEventKey(e,"down")){this._closeOnBlurIsPrevented=!0;this._onArrowDown();this._closeOnBlurIsPrevented=!1;e.preventDefault()}else if(this._isEventKey(e,"up")){this._closeOnBlurIsPrevented=!0;this._onArrowUp();this._closeOnBlurIsPrevented=!1;e.preventDefault()}else if(this._isEventKey(e,"enter")){this._onEnter(e)}else if(this._isEventKey(e,"esc")){this._onEscape(e)}}_isEventKey(e,k){return _ironA11yKeysBehavior.IronA11yKeysBehavior.keyboardEventMatchesKeys(e,k)}_getItemLabel(item){return this.$.overlay.getItemLabel(item)}_getItemValue(item){let value=item?this.get(this.itemValuePath,item):void 0;if(value===void 0){value=item?item.toString():""}return value}_onArrowDown(){if(this.opened){if(this.$.overlay._items){this._focusedIndex=Math.min(this.$.overlay._items.length-1,this._focusedIndex+1);this._prefillFocusedItemLabel()}}else{this.open()}}_onArrowUp(){if(this.opened){if(-1<this._focusedIndex){this._focusedIndex=Math.max(0,this._focusedIndex-1)}else{if(this.$.overlay._items){this._focusedIndex=this.$.overlay._items.length-1}}this._prefillFocusedItemLabel()}else{this.open()}}_prefillFocusedItemLabel(){if(-1<this._focusedIndex){this._inputElementValue="";setTimeout(()=>{this._inputElementValue=this._getItemLabel(this.$.overlay._focusedItem);this._markAllSelectionRange()},1)}}_setSelectionRange(start,end){const input=this._nativeInput||this.inputElement;if(this.hasAttribute("focused")&&input&&input.setSelectionRange){try{input.setSelectionRange(start,end)}catch(ignore){}}}_markAllSelectionRange(){if(this._inputElementValue!==void 0){this._setSelectionRange(0,this._inputElementValue.length)}}_clearSelectionRange(){if(this._inputElementValue!==void 0){const pos=this._inputElementValue?this._inputElementValue.length:0;this._setSelectionRange(pos,pos)}}_onEnter(e){if(this.opened&&(this.allowCustomValue||""===this._inputElementValue||-1<this._focusedIndex)){this.close();e.preventDefault()}}_onEscape(e){if(this.opened){this._stopPropagation(e);if(-1<this._focusedIndex){this._focusedIndex=-1;this._revertInputValue()}else{this.cancel()}}}_toggleElementChanged(toggleElement){if(toggleElement){toggleElement.addEventListener("mousedown",e=>e.preventDefault())}}_clear(){this.selectedItem=null;if(this.allowCustomValue){this.value=""}if(!this.opened){this._detectAndDispatchChange()}}cancel(){this._revertInputValueToValue();this._lastCommittedValue=this.value;this.close()}_onOpened(){_flush.flush&&(0,_flush.flush)();this.$.overlay.ensureItemsRendered();this.$.overlay._selector.toggleScrollListener(!0);this.$.overlay.updateViewportBoundaries();_async.microTask.run(()=>this.$.overlay.adjustScrollPosition());setTimeout(()=>this.$.overlay.$.dropdown.notifyResize(),1);this._lastCommittedValue=this.value}_onClosed(){if(this.opened){this.close()}if(this.$.overlay._items&&-1<this._focusedIndex){const focusedItem=this.$.overlay._items[this._focusedIndex];if(this.selectedItem!==focusedItem){this.selectedItem=focusedItem}this._inputElementValue=this._getItemLabel(this.selectedItem)}else if(""===this._inputElementValue||this._inputElementValue===void 0){this.selectedItem=null;if(this.allowCustomValue){this.value=""}}else{if(this.allowCustomValue){const e=new CustomEvent("custom-value-set",{detail:this._inputElementValue,composed:!0,cancelable:!0,bubbles:!0});this.dispatchEvent(e);if(!e.defaultPrevented){const customValue=this._inputElementValue;this.selectedItem=null;this.value=customValue}}else{this._inputElementValue=this._getItemLabel(this.selectedItem)}}this._detectAndDispatchChange();this._clearSelectionRange();this.filter=""}_inputValueChanged(e){if(-1!==e.composedPath().indexOf(this.inputElement)){this._inputElementValue=this.inputElement.value;this._filterFromInput()}}_filterFromInput(){if(!this.opened){this.open()}if(this.filter===this._inputElementValue){this._filterChanged(this.filter,this.itemValuePath,this.itemLabelPath)}else{this.filter=this._inputElementValue}}_filterChanged(filter,itemValuePath,itemLabelPath){if(filter===void 0||itemValuePath===void 0||itemLabelPath===void 0){return}if(this.items){this.filteredItems=this._filterItems(this.items,filter)}else{this._filteredItemsChanged({path:"filteredItems",value:this.filteredItems},itemValuePath,itemLabelPath)}}_loadingChanged(loading){if(loading){this._focusedIndex=-1}}_revertInputValue(){if(""!==this.filter){this._inputElementValue=this.filter}else{this._revertInputValueToValue()}this._clearSelectionRange()}_revertInputValueToValue(){if(this.allowCustomValue&&!this.selectedItem){this._inputElementValue=this.value}else{this._inputElementValue=this._getItemLabel(this.selectedItem)}}_updateHasValue(hasValue){if(hasValue){this.setAttribute("has-value","")}else{this.removeAttribute("has-value")}}_selectedItemChanged(selectedItem){if(null===selectedItem||selectedItem===void 0){if(this.filteredItems){if(!this.allowCustomValue){this.value=""}this._updateHasValue(""!==this.value);this._inputElementValue=this.value}}else{const value=this._getItemValue(selectedItem);if(this.value!==value){this.value=value}this._updateHasValue(!0);this._inputElementValue=this._getItemLabel(selectedItem);if(this.inputElement){this.inputElement.value=this._inputElementValue}}this.$.overlay._selectedItem=selectedItem;if(this.filteredItems&&this.$.overlay._items){this._focusedIndex=this.filteredItems.indexOf(selectedItem)}}_valueChanged(value,oldVal){if(""===value&&oldVal===void 0){return}if(this._isValidValue(value)){let item;if(this._getItemValue(this.selectedItem)!==value){const valueIndex=this._indexOfValue(value,this.filteredItems);this.selectedItem=0<=valueIndex?this.filteredItems[valueIndex]:null}else{item=this.selectedItem}if(!item&&this.allowCustomValue){this._inputElementValue=value}this._updateHasValue(""!==this.value)}else{this.selectedItem=null}this._lastCommittedValue=void 0}_detectAndDispatchChange(){if(this.value!==this._lastCommittedValue){this.dispatchEvent(new CustomEvent("change",{bubbles:!0}));this._lastCommittedValue=this.value}}_itemsChanged(e,itemValuePath,itemLabelPath){if(e.value===void 0||itemValuePath===void 0||itemLabelPath===void 0){return}if("items"===e.path||"items.splices"===e.path){this.filteredItems=this.items?this.items.slice(0):this.items;const valueIndex=this._indexOfValue(this.value,this.items);this._focusedIndex=valueIndex;const item=-1<valueIndex&&this.items[valueIndex];if(item){this.selectedItem=item}}}_filteredItemsChanged(e,itemValuePath,itemLabelPath){if(e.value===void 0||itemValuePath===void 0||itemLabelPath===void 0){return}if("filteredItems"===e.path||"filteredItems.splices"===e.path){this._setOverlayItems(this.filteredItems);this._focusedIndex=this.opened?this.$.overlay.indexOfLabel(this.filter):this._indexOfValue(this.value,this.filteredItems);setTimeout(()=>{this.$.overlay.$.dropdown.notifyResize()},1)}}_filterItems(arr,filter){if(!arr){return arr}return arr.filter(item=>{filter=filter?filter.toString().toLowerCase():"";return-1<this._getItemLabel(item).toString().toLowerCase().indexOf(filter)})}_setOverlayItems(items){this.$.overlay.set("_items",items);this.$.overlay.$.dropdown.notifyResize()}_indexOfValue(value,items){if(items&&this._isValidValue(value)){for(let i=0;i<items.length;i++){if(this._getItemValue(items[i])===value){return i}}}return-1}_isValidValue(value){return value!==void 0&&null!==value}_overlaySelectedItemChanged(e){if(this.selectedItem!==e.detail.item){this.selectedItem=e.detail.item}if(this.opened){this.close()}e.stopPropagation()}validate(){return!(this.invalid=!this.checkValidity())}checkValidity(){if(this.inputElement.validate){return this.inputElement.validate()}}get _instanceProps(){return{item:!0,index:!0,selected:!0,focused:!0}}_ensureTemplatized(){if(!this._TemplateClass){const tpl=this.querySelector("template");if(tpl){this._TemplateClass=(0,_templatize.templatize)(tpl,this,{instanceProps:this._instanceProps,forwardHostProp:function(prop,value){const items=this.$.overlay._selector.querySelectorAll("vaadin-combo-box-item");Array.prototype.forEach.call(items,item=>{if(item._itemTemplateInstance){item._itemTemplateInstance.set(prop,value);item._itemTemplateInstance.notifyPath(prop,value,!0)}})}})}}}_preventInputBlur(){if(this._toggleElement){this._toggleElement.addEventListener("click",this._preventDefault)}if(this._clearElement){this._clearElement.addEventListener("click",this._preventDefault)}}_restoreInputBlur(){if(this._toggleElement){this._toggleElement.removeEventListener("click",this._preventDefault)}if(this._clearElement){this._clearElement.removeEventListener("click",this._preventDefault)}}_preventDefault(e){e.preventDefault()}_stopPropagation(e){e.stopPropagation()}}});