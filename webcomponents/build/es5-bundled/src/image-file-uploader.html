<html><head></head><body><dom-module id="image-file-uploader"><template><style>#drop_zone{height:200px;border:0px dashed #bbb;-moz-border-radius:5px;-webkit-border-radius:5px;border-radius:5px;padding:25px;margin-bottom:8px;text-align:center;font:20pt bold "Helvetica";color:#bbb;background-size:contain;background-repeat:no-repeat;background-position:center;}#drop_hint{display:none;}</style><div id="drop_zone" style="background-image: url([[src]]);"><span id="drop_hint">Drop files here</span></div></template><script>var ImageFileUploader=function(_Polymer$Element){babelHelpers.inherits(ImageFileUploader,_Polymer$Element);function ImageFileUploader(){babelHelpers.classCallCheck(this,ImageFileUploader);return babelHelpers.possibleConstructorReturn(this,(ImageFileUploader.__proto__||Object.getPrototypeOf(ImageFileUploader)).apply(this,arguments))}babelHelpers.createClass(ImageFileUploader,[{key:"handleFileSelect",value:function handleFileSelect(evt){evt.stopPropagation();evt.preventDefault();if(this.accessToken){for(var files=evt.dataTransfer.files,i=0,f,uploader;f=files[i];i++){uploader=new MediaUploader({file:f,token:this.accessToken,onComplete:function(json){this.handleDragLeave();var data=JSON.parse(json);if(data&&data.webContentLink){this.src=data.webContentLink}}.bind(this)});uploader.upload()}}else{console.log("Missing accessToken")}}},{key:"handleDragOver",value:function handleDragOver(evt){var el=this.shadowRoot.getElementById("drop_zone");if(el){el.style.borderWidth="2px"}var hint=this.shadowRoot.getElementById("drop_hint");if(hint){hint.style.display="block"}if(evt){evt.stopPropagation();evt.preventDefault();evt.dataTransfer.dropEffect="copy"}}},{key:"handleDragLeave",value:function handleDragLeave(evt){var el=this.shadowRoot.getElementById("drop_zone");if(el){el.style.borderWidth="0px"}var hint=this.shadowRoot.getElementById("drop_hint");if(hint){hint.style.display="none"}if(evt){evt.stopPropagation();evt.preventDefault()}}},{key:"ready",value:function ready(){babelHelpers.get(ImageFileUploader.prototype.__proto__||Object.getPrototypeOf(ImageFileUploader.prototype),"ready",this).call(this);var el=this.shadowRoot.getElementById("drop_zone");el.addEventListener("dragover",this.handleDragOver.bind(this),!1);el.addEventListener("dragleave",this.handleDragLeave.bind(this),!1);el.addEventListener("drop",this.handleFileSelect.bind(this),!1)}},{key:"accessToken",get:function get(){var accessToken=null,authInstance=gapi&&gapi.auth2&&gapi.auth2.getAuthInstance();if(authInstance){var currentUser=authInstance&&authInstance.currentUser&&authInstance.currentUser.get();if(currentUser){var authResponse=currentUser.getAuthResponse(!0);if(authResponse){if("access_token"in authResponse){accessToken=authResponse.access_token}}}}return accessToken}}],[{key:"is",get:function get(){return"image-file-uploader"}},{key:"properties",get:function get(){return{src:{type:String,value:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="},emptyImageData:{type:String,value:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="}}}}]);return ImageFileUploader}(Polymer.Element);customElements.define(ImageFileUploader.is,ImageFileUploader);</script></dom-module><script type="text/javascript">var RetryHandler=function(){this.interval=1e3;this.maxInterval=1e3*60};RetryHandler.prototype.retry=function(fn){setTimeout(fn,this.interval);this.interval=this.nextInterval_()};RetryHandler.prototype.reset=function(){this.interval=1e3};RetryHandler.prototype.nextInterval_=function(){var interval=2*this.interval+this.getRandomInt_(0,1e3);return Math.min(interval,this.maxInterval)};RetryHandler.prototype.getRandomInt_=function(min,max){return Math.floor(Math.random()*(max-min+1)+min)};var MediaUploader=function(options){var noop=function(){};this.file=options.file;this.contentType=options.contentType||this.file.type||"application/octet-stream";this.metadata=options.metadata||{title:this.file.name,mimeType:this.contentType};this.token=options.token;this.onComplete=options.onComplete||noop;this.onProgress=options.onProgress||noop;this.onError=options.onError||noop;this.offset=options.offset||0;this.chunkSize=options.chunkSize||0;this.retryHandler=new RetryHandler;this.url=options.url;if(!this.url){var params=options.params||{};params.uploadType="resumable";this.url=this.buildUrl_(options.fileId,params,options.baseUrl)}this.httpMethod=options.fileId?"PUT":"POST"};MediaUploader.prototype.upload=function(){var self=this,xhr=new XMLHttpRequest;xhr.open(this.httpMethod,this.url,!0);xhr.setRequestHeader("Authorization","Bearer "+this.token);xhr.setRequestHeader("Content-Type","application/json");xhr.setRequestHeader("X-Upload-Content-Length",this.file.size);xhr.setRequestHeader("X-Upload-Content-Type",this.contentType);xhr.onload=function(e){if(400>e.target.status){var location=e.target.getResponseHeader("Location");this.url=location;this.sendFile_()}else{this.onUploadError_(e)}}.bind(this);xhr.onerror=this.onUploadError_.bind(this);xhr.send(JSON.stringify(this.metadata))};MediaUploader.prototype.sendFile_=function(){var content=this.file,end=this.file.size;if(this.offset||this.chunkSize){if(this.chunkSize){end=Math.min(this.offset+this.chunkSize,this.file.size)}content=content.slice(this.offset,end)}var xhr=new XMLHttpRequest;xhr.open("PUT",this.url,!0);xhr.setRequestHeader("Content-Type",this.contentType);xhr.setRequestHeader("Content-Range","bytes "+this.offset+"-"+(end-1)+"/"+this.file.size);xhr.setRequestHeader("X-Upload-Content-Type",this.file.type);if(xhr.upload){xhr.upload.addEventListener("progress",this.onProgress)}xhr.onload=this.onContentUploadSuccess_.bind(this);xhr.onerror=this.onContentUploadError_.bind(this);xhr.send(content)};MediaUploader.prototype.resume_=function(){var xhr=new XMLHttpRequest;xhr.open("PUT",this.url,!0);xhr.setRequestHeader("Content-Range","bytes */"+this.file.size);xhr.setRequestHeader("X-Upload-Content-Type",this.file.type);if(xhr.upload){xhr.upload.addEventListener("progress",this.onProgress)}xhr.onload=this.onContentUploadSuccess_.bind(this);xhr.onerror=this.onContentUploadError_.bind(this);xhr.send()};MediaUploader.prototype.extractRange_=function(xhr){var range=xhr.getResponseHeader("Range");if(range){this.offset=parseInt(range.match(/\d+/g).pop(),10)+1}};MediaUploader.prototype.onContentUploadSuccess_=function(e){if(200==e.target.status||201==e.target.status){this.onComplete(e.target.response)}else if(308==e.target.status){this.extractRange_(e.target);this.retryHandler.reset();this.sendFile_()}else{this.onContentUploadError_(e)}};MediaUploader.prototype.onContentUploadError_=function(e){if(e.target.status&&500>e.target.status){this.onError(e.target.response)}else{this.retryHandler.retry(this.resume_.bind(this))}};MediaUploader.prototype.onUploadError_=function(e){this.onError(e.target.response)};MediaUploader.prototype.buildQuery_=function(params){params=params||{};return Object.keys(params).map(function(key){return encodeURIComponent(key)+"="+encodeURIComponent(params[key])}).join("&")};MediaUploader.prototype.buildUrl_=function(id,params,baseUrl){var url=baseUrl||"https://www.googleapis.com/upload/drive/v2/files/";if(id){url+=id}var query=this.buildQuery_(params);if(query){url+="?"+query}return url};</script></body></html>