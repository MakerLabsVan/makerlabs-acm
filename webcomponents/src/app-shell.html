<link rel="import" href="../bower_components/polymer/polymer-element.html">

<!-- App Layout -->
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<!-- Cross-Domain HTTP Requests via JSONP -->
<link rel="import" href="../bower_components/iron-jsonp-library/iron-jsonp-library.html">

<!-- Google Sign-In, Sheets, Charts, ... -->
<link rel="import" href="../bower_components/google-signin/google-signin.html">
<link rel="import" href="../bower_components/google-apis/google-apis.html">

<!-- Local Components -->
<link rel="import" href="user-search-bar.html">
<link rel="import" href="view-user-form.html">

<dom-module id="app-shell">
  <template>
    <style>
      app-toolbar {
        background-color: #1E88E5;
        font-family: "Roboto", Helvetica, sans-serif;
        color: white;
        --app-toolbar-font-size: 24px;
      }
      .search-bar {
        width: 50%;
      }
      .search-bar vaadin-combo-box {
        width: 50%;
      }
    </style>

    <app-header-layout>
      <!-- Google Data, APIs, and Auth -->
      <google-client-loader
        id="sheets"
        name="sheets"
        version="v4"
      >
      </google-client-loader>

      <!-- Form Fields via Google Apps Script / JSONP -->
      <iron-jsonp-library
        library-url="[[fieldsUrl]]&access_token=[[accessToken]]&callback=%%callback%%"
        notify-event="fields-load"
        library-loaded="{{fieldsLoaded}}">
      </iron-jsonp-library>

      <!-- App Layout -->
      <app-header slot="header" fixed>
        <app-toolbar>
          <google-signin
            client-id="[[oauthClientId]]"
            scopes="[[oauthScopes]]"
          ></google-signin>
          <div main-title>
            <span>MakerLabs ACM</span>
          </div>
          <user-search-bar class="search-bar"></user-search-bar>
        </app-toolbar>
      </app-header>

      <!-- Render Form -->
      <view-user-form
        fields="[[fields]]"
        access-token="[[accessToken]]"
        query="[[query]]"
      >
      </view-user-form>
    </app-header-layout>
  </template>

  <script>
    class AppShell extends Polymer.Element {
      static get is() { return "app-shell"; }

      static get fetchInitialQuery() {
        // TODO(@paulreimer): From Google Apps Script:
        // JSON.stringify(e.parameters)
        return {};
      }

      static get properties() {
        return {
          accessToken: {
            type: String
          },
          oauthClientId: {
            type: String
          },
          oauthScopes: {
            type: String
          },
          fields: {
            type: Array
          },
          fieldsUrl: {
            type: String
          },
          userName: {
            type: String
          },
          query: {
            type: Object
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();

        this.addEventListener("fields-load", () => {
          this.fields = acm.userFields;
        });
      }

      ready() {
        super.ready();

        var intervalId = setInterval(
          function() {
            if (gapi) {
              if (gapi.client) {
                var clients = this.querySelectorAll("google-client-loader");
                for (var i = 0; i < clients.length; i++) {
                  console.log("Force loaded gapi.client");
                  clients[i]._loadClient();
                }
                clearInterval(intervalId);
              }
              else {
                console.log("Missing gapi.client");
                gapi.load("client", function(){});
              }
            }
            else {
              console.log("Missing gapi global");
            }
          }.bind(this),
          2000
        );
      }

      get accessToken() {
        var accessToken = "NONE";

        var authInstance = (
          gapi
          && gapi.auth2
          && gapi.auth2.getAuthInstance()
        );

        if (authInstance)
        {
          var currentUser = (
            authInstance
            && authInstance.currentUser
            && authInstance.currentUser.get()
          );

          if (currentUser) {
            var authResponse = currentUser.getAuthResponse(true);
            if (authResponse) {
              if ("access_token" in authResponse) {
                accessToken = authResponse["access_token"];
              }
            }
          }
        }

        console.log("accessToken = " + accessToken);
        return accessToken;
      }

    }

    customElements.define(AppShell.is, AppShell);
  </script>

</dom-module>
